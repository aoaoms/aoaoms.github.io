(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{515:function(s,n,a){"use strict";a.r(n);var e=a(4),t=Object(e.a)({},function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#开篇"}},[s._v("开篇")])]),a("li",[a("a",{attrs:{href:"#关于此篇"}},[s._v("关于此篇")])]),a("li",[a("a",{attrs:{href:"#动手前的准备"}},[s._v("动手前的准备")])]),a("li",[a("a",{attrs:{href:"#修改proxy代理"}},[s._v("修改proxy代理")])]),a("li",[a("a",{attrs:{href:"#接口规格匹配一致"}},[s._v("接口规格匹配一致")])]),a("li",[a("a",{attrs:{href:"#测试登录"}},[s._v("测试登录")]),a("ul",[a("li",[a("a",{attrs:{href:"#修改login-vue进行测试"}},[s._v("修改login.vue进行测试")])])])]),a("li",[a("a",{attrs:{href:"#测试获取用户信息"}},[s._v("测试获取用户信息")])]),a("li",[a("a",{attrs:{href:"#分离获取用户权限接口"}},[s._v("分离获取用户权限接口")]),a("ul",[a("li",[a("a",{attrs:{href:"#新建获取用户权限接口"}},[s._v("新建获取用户权限接口")])]),a("li",[a("a",{attrs:{href:"#分离动态路由处理权限的代码"}},[s._v("分离动态路由处理权限的代码")])]),a("li",[a("a",{attrs:{href:"#设置动态路由鉴权码"}},[s._v("设置动态路由鉴权码")])]),a("li",[a("a",{attrs:{href:"#接口返回鉴权码"}},[s._v("接口返回鉴权码")])]),a("li",[a("a",{attrs:{href:"#测试获取鉴权码"}},[s._v("测试获取鉴权码")])])])]),a("li",[a("a",{attrs:{href:"#完结"}},[s._v("完结")])]),a("li",[a("a",{attrs:{href:"#友链"}},[s._v("友链")])])])]),a("p"),s._v(" "),a("h2",{attrs:{id:"开篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开篇","aria-hidden":"true"}},[s._v("#")]),s._v(" 开篇")]),s._v(" "),a("p",[s._v("作者最近在使用"),a("a",{attrs:{href:"https://github.com/aoaoms/vue-element-admin",target:"_blank",rel:"noopener noreferrer"}},[s._v("vue-element-admin"),a("OutboundLink")],1),s._v(" 框架写一个电商后台管理系统；前端初级学员一枚。希望借此框架的具体实践，能够对于前端开发技能有进一步的提高。这个框架确实挺好的，开源并持续维护了几年了。"),a("a",{attrs:{href:"https://github.com/aoaoms/vue-element-admin",target:"_blank",rel:"noopener noreferrer"}},[s._v("github"),a("OutboundLink")],1),s._v(" star也是杠杠的！欢迎支持，为作者点赞！")]),s._v(" "),a("h2",{attrs:{id:"关于此篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于此篇","aria-hidden":"true"}},[s._v("#")]),s._v(" 关于此篇")]),s._v(" "),a("p",[s._v("前一篇介绍了初步运行此框架模板应用，了解了从登录到菜单路由导航的概要实现。动态路由很好的运用于系统鉴权的实现。而此篇，目标是要完成实时接口访问后端开发环境，用联调接口的方式来继续后面的开发。由于，作者本人后端使用"),a("a",{attrs:{href:"http://www.jfinal.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("JFinal"),a("OutboundLink")],1),s._v("技术栈 主要完成后排的API 服务，开发接口速度之快，使得联调接口更加的方便实现；数据更加的贴合实际。目标：")]),s._v(" "),a("ul",[a("li",[s._v("配置代理完成前端axios请求转发到后端测试接口")]),s._v(" "),a("li",[s._v("完成登录、获取用户信息、获取用户权限、动态路由加载导航菜单流程")])]),s._v(" "),a("h2",{attrs:{id:"动手前的准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#动手前的准备","aria-hidden":"true"}},[s._v("#")]),s._v(" 动手前的准备")]),s._v(" "),a("p",[s._v("还是要看下框架作者写的几篇上手手册"),a("a",{attrs:{href:"https://juejin.im/post/59097cd7a22b9d0065fb61d2",target:"_blank",rel:"noopener noreferrer"}},[s._v("手摸手，带你用vue撸后台"),a("OutboundLink")],1),s._v(" ；感谢作者，前端的老鸟。其中"),a("a",{attrs:{href:"https://juejin.im/post/595b4d776fb9a06bbe7dba56",target:"_blank",rel:"noopener noreferrer"}},[s._v("第四篇"),a("OutboundLink")],1),s._v(" 简单的说了下使用webpack 的proxy实现跨域请求转发。当然，我们自己也可以想一想。框架不可能做到与你后台实际的接口规范一致，里面涉及了一些硬编码还需要自己依据实际项目接口做调整。下面，我们就一步步做起来。")]),s._v(" "),a("h2",{attrs:{id:"修改proxy代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改proxy代理","aria-hidden":"true"}},[s._v("#")]),s._v(" 修改proxy代理")]),s._v(" "),a("p",[s._v("文件路径：./vue.config.js ;我按照自己项目后台的服务地址http://localhost 做了以下修改：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// process.env.VUE_APP_BASE_API ---------\x3e  /dev-api")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// change xxx-api/login => mock/login")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// detail: https://cli.vuejs.org/config/#devserver-proxy")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("VUE_APP_BASE_API")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://localhost'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        changeOrigin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        pathRewrite"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("VUE_APP_BASE_API")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("blockquote",[a("p",[s._v("上面的process.env.VUE_APP_BASE_API 是前端项目的开发服务地址 实际上是一个字串'dev-api'；项目里面定义了2个环境编码，一个是开发的，一个是生产的，以编码标记 后续打包用到。项目开发地址在此配置文件里面也有说明，默认开启本机9528端口。\n而我后台的开发服务地址是本机80端口，所以在目标target属性里面改为 'http://localhost'; 上面的配置意思为：所有/dev-api 的请求地址会转发到http://localhost ;也就是原始请求地址是 http://localhost:9528/dev-api/****** 修改后变为 http://localhost/dev-api 。下面的pathRewrite 再配置重写地址为将/dev-api替换为空字符，那么代理后的地址就变成了 http://localhost/你的请求地址。这就与我们后端开发的服务接口一样啦。")])]),s._v(" "),a("h2",{attrs:{id:"接口规格匹配一致"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#接口规格匹配一致","aria-hidden":"true"}},[s._v("#")]),s._v(" 接口规格匹配一致")]),s._v(" "),a("p",[s._v("框架自己硬编码的地址、参数和请求拦截处理可能与你的后台地址不一样，这里需要改下。例如本人的登录接口地址为/login/dologin ；框架里面的是/user/login 。这就需要改改了。重要的一点，就是请求的响应拦截处理。本人在修改了接口后，登录还是一致报错，后来发现是框架封装了axios请求响应，其封装的逻辑与本人后端的接口服务响应规范不一致，处罚了异常。\n框架的请求响应封装如下：文件：./src/utils/request.js")]),s._v(" "),a("div",{staticClass:"language-js{ 4 } line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("response => {\n    const res = response.data\n\n    // if the custom code is not 20000, it is judged as an error.\n\n    // i used jfinal Ret,it is juged as an error if return state is not 'ok' or http response status is not 200\n    // if (res.code !== 20000) {\n    if ((res.state !== 'ok') && (response.status !== 200)) {\n      Message({\n        message: res.message || 'Error',\n        type: 'error',\n        duration: 5 * 1000\n      })\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("blockquote",[a("p",[s._v("以上代码，我做了修改。框架原来封装响应处理做了硬编码 返回值不等于20000 的异常处理。而我的项目请求响应存在2种情况，一种是响应一个对象字串，其中包括状态state说明。另一种是直接响应http status=200,返回json数据。\n所以，这里我改了判断异常的条件。")])]),s._v(" "),a("p",[s._v("我看了下登录这块儿大致有以下几点，需要注意调整：")]),s._v(" "),a("ul",[a("li",[s._v("接口地址匹配")]),s._v(" "),a("li",[s._v("接口参数（框架封装了请求 里面包含header固定传参token处理并且属性名为X-Token；注意与自己项目使用是否一致）")]),s._v(" "),a("li",[s._v("响应封装修改")]),s._v(" "),a("li",[s._v("响应的数据格式写入(主要是提交请求后 你自己项目的返回数据需要与框架里面调用并处理token配合调整)")])]),s._v(" "),a("h2",{attrs:{id:"测试登录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试登录","aria-hidden":"true"}},[s._v("#")]),s._v(" 测试登录")]),s._v(" "),a("p",[s._v("经过以上的代理配置，以及请求封装的修改后。开始测试以下登录操作：")]),s._v(" "),a("h3",{attrs:{id:"修改login-vue进行测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改login-vue进行测试","aria-hidden":"true"}},[s._v("#")]),s._v(" 修改login.vue进行测试")]),s._v(" "),a("p",[s._v("文件路径：/src/views/login.vue ；自动填上账号和密码 便于调试：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("return {\n      loginForm: {\n        username: 'admin',\n        password: '****************'\n      },\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("处理登录的事件，添加打印输出：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("handleLogin() {\n      this.$refs.loginForm.validate(valid => {\n        if (valid) {\n          this.loading = true\n          this.$store.dispatch('user/login', this.loginForm).then(() => {\n            // 登录成功\n            const token = getToken()\n            console.log('---------------\x3e done loginForm ,token is ' + token)\n            this.$router.push({ path: this.redirect || '/' })\n            this.loading = false\n          }).catch(() => {\n            this.loading = false\n          })\n        } else {\n          console.log('error submit!!')\n          return false\n        }\n      })\n    }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("blockquote",[a("p",[s._v("以上代码可以看出 登录完成的逻辑。经过输入验证后，"),a("a",{attrs:{href:"https://vuex.vuejs.org/zh/",target:"_blank",rel:"noopener noreferrer"}},[s._v("store"),a("OutboundLink")],1),s._v(" 分配用户登录Action进行异步处理。这里我添加处理成功则控制台输出获取到的token 。正常处理登录成功后，下一步是路由的跳转：")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 这行代码会触发路由的beforeEach钩子函数 里面进行后续获取用户信息以及动态路由的操作\nthis.$router.push({ path: this.redirect || '/' })\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://github.com/aoaoms/public-ansets/raw/master/element-admin/testLogin.png",alt:"测试登录"}})]),s._v(" "),a("p",[s._v("使用谷歌开发工具，查看登录处理输出结果。查看网络处理内容。可以看到，点击login按钮后发生了错误，系统停止处理。步骤1网络请求doLogin 处理成功，控制台输出了获取到的token 。步骤2 网络处理请求 getUserInfo 处理返回也是成功的response head status 200 ；但是控制台输出了错误信息：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vue.runtime.esm.js:619 [Vue warn]: data functions should return an object:\nhttps://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function\n\n(found in <Root>)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("blockquote",[a("p",[s._v("这个错误应该是请求成功后的响应结果处理出现了问题，提报这个data需要返回一个对象。那么可能是我实际接口返回的数据系统在接收处理结果时类型错误导致。下节我们细看一下代码，作修正。")])]),s._v(" "),a("h2",{attrs:{id:"测试获取用户信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试获取用户信息","aria-hidden":"true"}},[s._v("#")]),s._v(" 测试获取用户信息")]),s._v(" "),a("p",[s._v("上节已经提到用户登录接口已处理成功。下一步在geUserInfo信息接口处理时抛出了异常。此接口调用在路由的beforeEach 钩子里面触发：文件路径：./permission.js")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 路由钩子函数\nrouter.beforeEach(async(to, from, next) => {\n  // start progress bar\n  NProgress.start()\n\n  // set page title\n  document.title = getPageTitle(to.meta.title)\n\n  // determine whether the user has logged in\n  const hasToken = getToken()\n\n  // aoaobaba: bug fixed,,, learn to: https://www.cnblogs.com/fqh123/p/11094296.html\n  if (to.path === from.path) {\n    next()\n    return\n  }\n\n  // aoaobaba: Listen for forward and next browser events\n  window.addEventListener('popstate', function() {\n    // backStatus = true\n    return\n  })\n\n  if (hasToken) {\n    if (to.path === '/login') {\n      // if is logged in, redirect to the home page\n      next({ path: '/' })\n      NProgress.done()\n    } else {\n      // determine whether the user has obtained his permission roles through getInfo\n      const hasRoles = store.getters.roles && store.getters.roles.length > 0\n      if (hasRoles) {\n        next()\n      } else {\n        try {\n          // get user info\n          // note: roles must be a object array! such as: ['admin'] or ,['developer','editor']\n          const { roles } = await store.dispatch('user/getInfo')\n\n          // generate accessible routes map based on roles\n          const accessRoutes = await store.dispatch('permission/generateRoutes', roles)\n\n          // dynamically add accessible routes\n          router.addRoutes(accessRoutes)\n\n          // hack method to ensure that addRoutes is complete\n          // set the replace: true, so the navigation will not leave a history record\n          next({ ...to, replace: true })\n        } catch (error) {\n          // remove token and go to login page to re-login\n          await store.dispatch('user/resetToken')\n          Message.error(error || 'Has Error')\n          next(`/login?redirect=${to.path}`)\n          NProgress.done()\n        }\n      }\n    }\n  } else {\n    /* has no token*/\n\n    if (whiteList.indexOf(to.path) !== -1) {\n      // in the free login whitelist, go directly\n      next()\n    } else {\n      // other pages that do not have permission to access are redirected to the login page.\n      next(`/login?redirect=${to.path}`)\n      NProgress.done()\n    }\n  }\n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br")])]),a("blockquote",[a("p",[s._v("以上代码可以看到 在get user info 处理过程中，声明了返回结果必须是个对象。通过store 分配action 'user/getinfo' 的处理结果需要返回一个对象。那么我们就去看下此action的处理：\n文件路径：./src/store/modules/user.js")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// get user info\n  getInfo({ commit, state }) {\n    return new Promise((resolve, reject) => {\n      getInfo().then(response => {\n        const { data } = response\n\n        if (!data) {\n          reject('Verification failed, please Login again.')\n        }\n\n        const { roles, name, avatar } = data\n\n        // roles must be a non-empty array\n        if (!roles || roles.length <= 0) {\n          reject('getInfo: roles must be a non-null array!')\n        }\n\n        commit('SET_ROLES', roles)\n        commit('SET_NAME', name)\n        commit('SET_AVATAR', avatar)\n        resolve(data)\n      }).catch(error => {\n        reject(error)\n      })\n    })\n  },\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("blockquote",[a("p",[s._v("上面代码中 "),a("code",[s._v("const { data } = response")]),s._v(" 这里处理请求返回的对象解构得到data新的对象属性，这里与我实际接口返回时冲突的。我的接口直接返回一个json字串对象，在请求响应拦截封装里面返回的；可以看下reques.js里面的请求响应拦截器处理。这个接口可以直接解构response对象，获得里面的属性。另外，我的项目此接口是不会返回用户角色信息"),a("code",[s._v("role")]),s._v(" 属性，因此这里还要取消"),a("code",[s._v("role")]),s._v("的处理。按自己接口定义的属性修改一下。这里处理权限相关的代码"),a("code",[s._v("commit('SET_ROLES', roles)")]),s._v(" 我们先注释掉，后续这个接口服务需要独立出来。\n修改后的代码：")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// get user info\n  getInfo({ commit, state }) {\n    return new Promise((resolve, reject) => {\n      getInfo().then(response => {\n        const data = response\n\n        if (!data) {\n          reject('Verification failed, please Login again.')\n        }\n\n        const { name, avatar } = data\n\n        // roles must be a non-empty array\n        // if (!roles || roles.length <= 0) {\n        //   reject('getInfo: roles must be a non-null array!')\n        // }\n\n        // commit('SET_ROLES', roles)\n        commit('SET_NAME', name)\n        commit('SET_AVATAR', avatar)\n\n        console.log('---------------\x3e well done  getinfo')\n        resolve(data)\n      }).catch(error => {\n        reject(error)\n      })\n    })\n  }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("p",[s._v("控制台输出")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("----------------\x3e done login\nindex.vue?fe92:151 ---------------\x3e done loginForm ,token is eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1aWQiOjIsImlzcyI6Im1hbGxhcGkiLCJleHAiOjE1NzAzMzE0NjIsImlhdCI6MTU3MDI0NTA2Mn0.hq6Q7Rjm8OMKLXxZzRE0xMuxHRw4KRBPPFuaG554aa\nuser.js:85 ---------------\x3e well done  getinfo\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("blockquote",[a("p",[s._v("data 声明直接指向response。 然后解构属性 name, avatar进行store设置处理。")])]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("以上getinfo接口处理返回了用户基本信息和权限。但实际项目的话，最好将其分成不同的接口提供服务；因为用户权限接口使用会更频繁，用户信息接口数据大部分项目会获取一次会缓存到本地。")]),s._v(" "),a("h2",{attrs:{id:"分离获取用户权限接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分离获取用户权限接口","aria-hidden":"true"}},[s._v("#")]),s._v(" 分离获取用户权限接口")]),s._v(" "),a("h3",{attrs:{id:"新建获取用户权限接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#新建获取用户权限接口","aria-hidden":"true"}},[s._v("#")]),s._v(" 新建获取用户权限接口")]),s._v(" "),a("ul",[a("li",[s._v("新增api"),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 获取用户鉴权码\nexport function getUserPermission() {\nreturn request({\n  url: '/user/getUserPermission',\n  method: 'get'\n  })\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])]),s._v(" "),a("li",[s._v("新增store action\n"),a("blockquote",[a("p",[s._v("我的项目获取用户鉴权码 请求返回一个array，类似 [a,b,c,d,d.....]")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// get user permission\ngetUserPermission({ commit, state }) {\n  return new Promise((resolve, reject) => {\n    getUserPermission().then(response => {\n      const roles = response\n\n      if (!roles) {\n        reject('Verification failed, please Login again.')\n      }\n      // roles must be a non-empty array\n      if (!roles || roles.length <= 0) {\n        reject('getUserPermission: roles must be a non-null array!')\n      }\n\n      commit('SET_ROLES', roles)\n      console.log('---------------\x3e well done  getUserPermission')\n      resolve(roles)\n    }).catch(error => {\n      reject(error)\n    })\n  })\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"分离动态路由处理权限的代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分离动态路由处理权限的代码","aria-hidden":"true"}},[s._v("#")]),s._v(" 分离动态路由处理权限的代码")]),s._v(" "),a("p",[s._v("路径：./permission.js")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// get user info\n// note: roles must be a object array! such as: ['admin'] or ,['developer','editor']\nawait store.dispatch('user/getInfo')\n\n// aoaobaba add: dispatch action to get user permission! roles is an array! example: [a,b,c,d,e.....]\nconst roles = await store.dispatch('user/getUserPermission')\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("blockquote",[a("p",[s._v("这添加了处理用户鉴权码的action")])]),s._v(" "),a("h3",{attrs:{id:"设置动态路由鉴权码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置动态路由鉴权码","aria-hidden":"true"}},[s._v("#")]),s._v(" 设置动态路由鉴权码")]),s._v(" "),a("p",[s._v("路径：./src/router/index.js\n"),a("code",[s._v("为了方便测试我们统一先给admin用户返回鉴权码 [wang],前端动态路由鉴权表里面的roles 属性也一同修改为[wang] 进行测试。")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("export const asyncRoutes = [\n  {\n    path: '/goods',\n    component: Layout,\n    redirect: '/goods/goodsCate',\n    name: 'Goods',\n    meta: {\n      title: '商品管理',\n      icon: 'nested',\n      roles: ['wang']\n    },\n    children: [\n      {\n        path: 'goodsCate',\n        name: 'GoodsCate',\n        meta: { title: '货品类目', roles: ['wang'] },\n        component: () => import('@/views/goods/goodsCate') // Parent router-view\n      },\n      {\n        path: 'goodsSpec',\n        name: 'GoodsSpec',\n        meta: { title: '货品规格', roles: ['wang'] },\n        component: () => import('@/views/table/index') // Parent router-view\n      }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h3",{attrs:{id:"接口返回鉴权码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#接口返回鉴权码","aria-hidden":"true"}},[s._v("#")]),s._v(" 接口返回鉴权码")]),s._v(" "),a("h3",{attrs:{id:"测试获取鉴权码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试获取鉴权码","aria-hidden":"true"}},[s._v("#")]),s._v(" 测试获取鉴权码")]),s._v(" "),a("p",[s._v("运行登录\n"),a("img",{attrs:{src:"https://github.com/aoaoms/public-ansets/raw/master/element-admin/testGetPermission.png",alt:"测试获取鉴权动态路由"}})]),s._v(" "),a("blockquote",[a("p",[s._v("以上截图，是修改代码后的测试结果。作者定义了几个鉴权路由菜单，这里也刷出来了。注意查看 Cookies里面已经缓存了会话token。日志里面也输出了action 正常处理完成啦。")])]),s._v(" "),a("h2",{attrs:{id:"完结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#完结","aria-hidden":"true"}},[s._v("#")]),s._v(" 完结")]),s._v(" "),a("p",[s._v("今天大致完成了框架修改，连接自己的开发接口服务进行实时接口数据联调开发；并进行了用户登录、获取用户信息、动态路由鉴权的场景。由于前后端都是作者一个人，所以做起来统一好安排。如果是项目团队，前端还是使用Mock数据服务好些。")]),s._v(" "),a("h2",{attrs:{id:"友链"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#友链","aria-hidden":"true"}},[s._v("#")]),s._v(" 友链")]),s._v(" "),a("ul",[a("li",[a("p",[a("a",{attrs:{href:"http://www.jfinal.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Jfinal"),a("OutboundLink")],1)])]),s._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://github.com/aoaoms/vue-element-admin",target:"_blank",rel:"noopener noreferrer"}},[s._v("vue-element-admin"),a("OutboundLink")],1)])])])])},[],!1,null,null,null);n.default=t.exports}}]);